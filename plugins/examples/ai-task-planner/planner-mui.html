<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>AI 任务规划助手</title>
	<style>
		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			padding: 0;
			font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		#root {
			width: 100%;
			height: 100vh;
		}

		.loading {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 100vh;
			font-size: 18px;
			color: #666;
		}

		/* Material-UI 基础样式 - 作为后备 */
		button {
			font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
			font-weight: 500;
			text-transform: uppercase;
			border: none;
			cursor: pointer;
			padding: 8px 16px;
			border-radius: 4px;
			transition: all 0.2s;
		}

		input,
		textarea {
			font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 8px;
			transition: border-color 0.2s;
		}

		input:focus,
		textarea:focus {
			outline: none;
			border-color: #1976d2;
		}
	</style>
</head>

<body>
	<div id="root">
		<div class="loading">正在加载 AI 任务规划助手...</div>
	</div>

	<script>
		// 等待主应用注入依赖
		function waitForDependencies(callback, maxAttempts = 100) {
			let attempts = 0
			console.log('[Planner] 开始等待依赖注入...')

			const check = setInterval(() => {
				attempts++
				console.log(`[Planner] 检查依赖 (尝试 ${attempts}/${maxAttempts}):`, {
					React: !!window.React,
					ReactDOM: !!window.ReactDOM,
					MaterialUI: !!window.MaterialUI,
					MaterialIcons: !!window.MaterialIcons,
					appTheme: !!window.appTheme
				})

				if (window.React && window.ReactDOM && window.MaterialUI) {
					clearInterval(check)
					console.log('[Planner] ✅ 依赖加载成功!')
					callback()
				} else if (attempts >= maxAttempts) {
					clearInterval(check)
					console.error('[Planner] ❌ 依赖加载超时')
					document.getElementById('root').innerHTML =
						'<div class="loading" style="color: red;">❌ 依赖加载失败<br/>请确保插件在 FlashNote 中打开</div>'
				}
			}, 100)
		}

		// 当依赖就绪后初始化 React 应用
		waitForDependencies(() => {
			const { React, ReactDOM, MaterialUI, MaterialIcons, appTheme, emotionCache, CacheProvider } = window
			const { useState, useEffect, useRef } = React
			const {
				ThemeProvider,
				CssBaseline,
				Box,
				Typography,
				Button,
				TextField,
				Chip,
				Stack,
				List,
				ListItem,
				ListItemText,
				IconButton,
				Divider,
				Alert,
				CircularProgress,
				LinearProgress,
				Checkbox,
				FormControlLabel,
				Collapse
			} = MaterialUI

			console.log('[Planner] emotionCache:', emotionCache)
			console.log('[Planner] CacheProvider:', CacheProvider)
			const {
				AutoAwesome: AutoAwesomeIcon,
				Send: SendIcon,
				Add: AddIcon,
				Delete: DeleteIcon,
				Edit: EditIcon,
				CheckCircle: CheckCircleIcon,
				Cancel: CancelIcon,
				ExpandMore: ExpandMoreIcon,
				ExpandLess: ExpandLessIcon
			} = MaterialIcons

			// 主应用组件
			function App() {
				const [taskDescription, setTaskDescription] = useState('')
				const [tasks, setTasks] = useState([])
				const [loading, setLoading] = useState(false)
				const [progress, setProgress] = useState(0)
				const [message, setMessage] = useState(null)
				const [expandedTask, setExpandedTask] = useState(null)
				const [editingIndex, setEditingIndex] = useState(null)

				// 示例任务
				const examples = [
					'准备下周的产品发布会',
					'学习 React 和 TypeScript',
					'整理家里的书房',
					'计划一次周末旅行'
				]

				// 生成任务
				const handleGenerate = async () => {
					if (!taskDescription.trim()) {
						setMessage({ type: 'warning', text: '请输入任务描述' })
						return
					}

					setLoading(true)
					setProgress(0)
					setMessage(null)
					setTasks([])

					// 模拟进度
					const progressTimer = setInterval(() => {
						setProgress(prev => Math.min(prev + Math.random() * 15, 95))
					}, 500)

					try {
						console.log('[Planner UI] 开始生成任务...')
						const result = await window.flashnotePlugin.executeCommand(
							'ai-task-planner',
							'ai-task-planner.generate',
							{ taskDescription }
						)

						console.log('[Planner UI] 收到响应:', result)
						clearInterval(progressTimer)
						setProgress(100)

						// 注意: IPC 返回格式是 { success: true, data: { status: 'success', tasks: [...] } }
						const responseData = result.data || result

						if (result.success && responseData.status === 'success' && responseData.tasks && Array.isArray(responseData.tasks) && responseData.tasks.length > 0) {
							console.log('[Planner UI] ✅ 生成成功:', responseData.tasks.length, '个任务')
							setTasks(responseData.tasks)
							setMessage({
								type: 'success',
								text: `成功生成 ${responseData.tasks.length} 个任务！`
							})
						} else {
							const errorMsg = responseData.error || result.error || '生成失败：返回数据格式不正确';
							console.error('[Planner UI] ❌ 生成失败:', {
								ipcSuccess: result.success,
								status: responseData.status,
								hasTasks: !!responseData.tasks,
								isArray: Array.isArray(responseData.tasks),
								length: responseData.tasks ? responseData.tasks.length : 'N/A',
								error: errorMsg,
								fullResult: result,
								fullResponseData: responseData
							})
							setMessage({
								type: 'error',
								text: errorMsg
							})
						}
					} catch (error) {
						console.error('[Planner UI] ❌ 请求异常:', error)
						clearInterval(progressTimer)
						setMessage({ type: 'error', text: error.message || '请求失败' })
					}

					setLoading(false)
				}

				// 更新任务
				const handleTaskUpdate = (index, field, value) => {
					const newTasks = [...tasks]
					newTasks[index] = { ...newTasks[index], [field]: value }
					setTasks(newTasks)
				}

				// 删除任务
				const handleDeleteTask = (index) => {
					setTasks(tasks.filter((_, i) => i !== index))
				}

				// 创建所有待办
				const handleCreateAll = async () => {
					if (tasks.length === 0) {
						setMessage({ type: 'warning', text: '没有要创建的任务' })
						return
					}

					// 标准化任务字段
					const normalizedTasks = tasks.map(task => ({
						content: task.content || '',
						description: task.description || '',
						is_important: Boolean(task.is_important),
						is_urgent: Boolean(task.is_urgent),
						due_date: task.due_date || null
					}))

					// 验证
					const invalidTasks = normalizedTasks.filter(t => !t.content || t.content.trim() === '')
					if (invalidTasks.length > 0) {
						setMessage({ type: 'error', text: '有任务内容为空，请先完善' })
						return
					}

					setLoading(true)
					try {
						const result = await window.flashnotePlugin.executeCommand(
							'ai-task-planner',
							'ai-task-planner.create-todos',
							{ tasks: normalizedTasks, taskDescription }
						)

						console.log('[Planner UI] 创建待办响应:', result)

						// 注意: IPC 返回格式是 { success: true, data: { status: 'success', ... } }
						const responseData = result.data || result

						if (result.success && responseData.status === 'success') {
							const summary = responseData.summary || {}
							setMessage({
								type: summary.success === summary.total ? 'success' : 'warning',
								text: `成功创建 ${summary.success}/${summary.total} 个待办事项！`
							})
							if (summary.success === summary.total) {
								setTasks([])
								setTaskDescription('')
							}
						} else {
							setMessage({ type: 'error', text: responseData.error || result.error || '创建失败' })
						}
					} catch (error) {
						console.error('[Planner UI] 创建待办异常:', error)
						setMessage({ type: 'error', text: error.message })
					}
					setLoading(false)
				}

				return React.createElement(ThemeProvider, { theme: appTheme },
					React.createElement(React.Fragment, null,
						React.createElement(CssBaseline),
						React.createElement(Box, {
							sx: {
								height: '100vh',
								bgcolor: 'background.default',
								overflow: 'auto'
							}
						},
							React.createElement(Box, { sx: { p: 3, maxWidth: 900, mx: 'auto' } },
								// 标题
								React.createElement(Box, { sx: { mb: 3, textAlign: 'center' } },
									React.createElement(Typography, {
										variant: 'h4',
										sx: {
											display: 'flex',
											alignItems: 'center',
											justifyContent: 'center',
											gap: 1,
											mb: 1
										}
									},
										React.createElement(AutoAwesomeIcon, { color: 'primary', fontSize: 'large' }),
										'AI 任务规划助手'
									),
									React.createElement(Typography, {
										variant: 'body2',
										color: 'text.secondary'
									}, '输入你的任务描述，AI 将帮助你拆解成可执行的待办事项')
								),

								// 消息提示
								message && React.createElement(Alert, {
									severity: message.type,
									sx: { mb: 2 },
									onClose: () => setMessage(null)
								}, message.text),

								// 输入区域
								React.createElement(Box, { sx: { mb: 3 } },
									React.createElement(TextField, {
										fullWidth: true,
										multiline: true,
										rows: 4,
										placeholder: '例如：准备下周的产品发布会',
										value: taskDescription,
										onChange: (e) => setTaskDescription(e.target.value),
										disabled: loading,
										sx: { mb: 2 }
									}),

									// 示例快捷按钮
									React.createElement(Box, { sx: { mb: 2 } },
										React.createElement(Typography, {
											variant: 'caption',
											color: 'text.secondary',
											sx: { mb: 1, display: 'block' }
										}, '试试这些示例：'),
										React.createElement(Stack, { direction: 'row', spacing: 1, flexWrap: 'wrap' },
											examples.map((example, idx) =>
												React.createElement(Chip, {
													key: idx,
													label: example,
													size: 'small',
													onClick: () => setTaskDescription(example),
													disabled: loading,
													sx: { mb: 1 }
												})
											)
										)
									),

									// 按钮组
									React.createElement(Stack, { direction: 'row', spacing: 2 },
										React.createElement(Button, {
											fullWidth: true,
											variant: 'contained',
											size: 'large',
											startIcon: loading ? React.createElement(CircularProgress, { size: 20, color: 'inherit' }) : React.createElement(SendIcon),
											onClick: handleGenerate,
											disabled: loading || !taskDescription.trim()
										}, loading ? '生成中...' : '生成任务计划')
									)
								),

								// 进度条
								loading && React.createElement(Box, { sx: { mb: 3 } },
									React.createElement(LinearProgress, {
										variant: 'determinate',
										value: progress,
										sx: { height: 6, borderRadius: 3 }
									})
								),

								// 任务列表
								tasks.length > 0 && React.createElement(Box, null,
									React.createElement(Box, {
										sx: {
											display: 'flex',
											alignItems: 'center',
											justifyContent: 'space-between',
											mb: 2
										}
									},
										React.createElement(Typography, { variant: 'h6' },
											'生成的任务'
										),
										React.createElement(Chip, {
											label: `${tasks.length} 项`,
											color: 'primary',
											size: 'small'
										})
									),
									React.createElement(Divider, { sx: { mb: 2 } }),

									// 任务列表
									React.createElement(List, { sx: { p: 0 } },
										tasks.map((task, index) =>
											React.createElement(React.Fragment, { key: index },
												React.createElement(ListItem, {
													sx: {
														display: 'flex',
														alignItems: 'flex-start',
														justifyContent: 'space-between',
														flexDirection: 'column',
														alignItems: 'stretch',
														gap: 1,
														py: 2
													}
												},
													// 任务标题和控制按钮
													React.createElement(Box, {
														sx: {
															display: 'flex',
															alignItems: 'center',
															width: '100%',
															justifyContent: 'space-between'
														}
													},
														React.createElement(TextField, {
															fullWidth: true,
															size: 'small',
															value: task.content || '',
															onChange: (e) => handleTaskUpdate(index, 'content', e.target.value),
															placeholder: '任务内容',
															sx: { mr: 2 }
														}),
														React.createElement(Box, { sx: { display: 'flex', gap: 1 } },
															React.createElement(IconButton, {
																size: 'small',
																onClick: () => setExpandedTask(expandedTask === index ? null : index)
															},
																expandedTask === index ?
																	React.createElement(ExpandLessIcon) :
																	React.createElement(ExpandMoreIcon)
															),
															React.createElement(IconButton, {
																size: 'small',
																color: 'error',
																onClick: () => handleDeleteTask(index)
															}, React.createElement(DeleteIcon))
														)
													),

													// 可展开的详细信息
													React.createElement(Collapse, { in: expandedTask === index },
														React.createElement(Box, { sx: { pt: 2, ml: 4, borderLeft: 3, borderColor: 'primary.main', pl: 2 } },
															// 描述
															React.createElement(TextField, {
																fullWidth: true,
																multiline: true,
																rows: 2,
																size: 'small',
																label: '详细描述',
																value: task.description || '',
																onChange: (e) => handleTaskUpdate(index, 'description', e.target.value),
																sx: { mb: 2 }
															}),

															// 重要和紧急标识
															React.createElement(Stack, { direction: 'row', spacing: 2, sx: { mb: 2 } },
																React.createElement(FormControlLabel, {
																	control: React.createElement(Checkbox, {
																		checked: Boolean(task.is_important),
																		onChange: (e) => handleTaskUpdate(index, 'is_important', e.target.checked)
																	}),
																	label: '重要'
																}),
																React.createElement(FormControlLabel, {
																	control: React.createElement(Checkbox, {
																		checked: Boolean(task.is_urgent),
																		onChange: (e) => handleTaskUpdate(index, 'is_urgent', e.target.checked)
																	}),
																	label: '紧急'
																})
															),

															// 截止日期和时间
															React.createElement(TextField, {
																type: 'datetime-local',
																size: 'small',
																label: '截止日期时间',
																value: task.due_date ? task.due_date.replace('T', 'T') : '',
																onChange: (e) => handleTaskUpdate(index, 'due_date', e.target.value),
																InputLabelProps: { shrink: true },
																sx: { mb: 1 },
																inputProps: {
																	min: new Date().toISOString().slice(0, 16) // 设置最小时间为当前时间
																}
															})
														)
													)
												),
												index < tasks.length - 1 && React.createElement(Divider, { sx: { mb: 0 } })
											)
										)
									),

									// 创建按钮
									React.createElement(Button, {
										fullWidth: true,
										variant: 'contained',
										size: 'large',
										color: 'success',
										startIcon: loading ? React.createElement(CircularProgress, { size: 20, color: 'inherit' }) : React.createElement(CheckCircleIcon),
										onClick: handleCreateAll,
										disabled: loading || tasks.length === 0,
										sx: { mt: 3 }
									}, loading ? '创建中...' : `创建所有待办 (${tasks.length})`)
								)
							)
						)
					)
				)
			}

			// 渲染应用 - 使用 CacheProvider 让样式注入到 iframe
			const root = ReactDOM.createRoot(document.getElementById('root'))

			// 验证 emotionCache
			if (emotionCache) {
				console.log('[Planner] emotionCache 结构:', {
					hasSheet: !!emotionCache.sheet,
					hasRegistered: !!emotionCache.registered,
					hasInserted: !!emotionCache.inserted,
					key: emotionCache.key
				})
			}

			// 如果有 emotionCache，用 CacheProvider 包裹（注意：应该用 cache 属性，不是 value）
			if (emotionCache && CacheProvider && emotionCache.sheet && emotionCache.registered) {
				console.log('[Planner] ✅ 使用 CacheProvider 包裹应用，样式将注入到 iframe')
				root.render(
					React.createElement(CacheProvider, { value: emotionCache },
						React.createElement(App)
					)
				)
			} else {
				console.warn('[Planner] ⚠️ emotionCache 无效或缺失，使用默认渲染（样式可能无法正确显示）')
				console.warn('[Planner] 状态:', {
					hasCache: !!emotionCache,
					hasProvider: !!CacheProvider,
					cacheValid: emotionCache && emotionCache.sheet && emotionCache.registered
				})
				console.warn('[Planner] 未找到 emotionCache 或 CacheProvider，使用默认渲染')
				root.render(React.createElement(App))
			}
		})
	</script>
</body>

</html>