# FlashNote 插件系统设计文档

## 1. 概述

FlashNote 插件系统采用模块化架构，支持主进程和渲染进程插件，提供丰富的 API 接口和生命周期钩子，确保插件的安全性和稳定性。

## 2. 插件架构设计

### 2.1 核心概念

- **插件目录**: `plugins/` - 所有插件存放的根目录
- **插件包**: 每个插件是一个独立的文件夹，包含完整的功能模块
- **插件清单**: `package.json` - 定义插件的元数据和依赖
- **插件入口**: `index.js` - 插件的主要逻辑文件

### 2.2 插件目录结构

```
plugins/
├── example-plugin/
│   ├── package.json          # 插件清单文件
│   ├── index.js              # 插件入口文件
│   ├── main/                 # 主进程相关代码
│   │   ├── handlers.js       # IPC 处理器
│   │   └── services.js       # 后端服务
│   ├── renderer/             # 渲染进程相关代码
│   │   ├── components/       # React 组件
│   │   ├── hooks/           # 自定义 Hooks
│   │   └── utils/           # 工具函数
│   ├── assets/              # 静态资源
│   │   ├── icons/
│   │   └── styles/
│   └── README.md            # 插件说明文档
```

## 3. 插件清单文件 (package.json)

```json
{
  "name": "example-plugin",
  "version": "1.0.0",
  "description": "示例插件",
  "main": "index.js",
  "flashnote": {
    "minVersion": "2.0.0",
    "maxVersion": "3.0.0",
    "permissions": [
      "notes:read",
      "notes:write",
      "settings:read",
      "system:notification"
    ],
    "contributes": {
      "commands": [
        {
          "id": "example.hello",
          "title": "Hello World",
          "category": "Example"
        }
      ],
      "menus": [
        {
          "id": "example.menu",
          "title": "示例菜单",
          "location": "toolbar"
        }
      ],
      "shortcuts": [
        {
          "id": "example.shortcut",
          "key": "Ctrl+Shift+E",
          "command": "example.hello"
        }
      ]
    }
  },
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "author": "Your Name",
  "license": "MIT"
}
```

## 4. 插件入口文件 (index.js)

```javascript
class ExamplePlugin {
  constructor() {
    this.name = 'example-plugin'
    this.version = '1.0.0'
  }

  // 插件加载时调用
  async onLoad(context) {
    console.log('插件加载:', this.name)
    this.context = context
    
    // 注册命令
    context.commands.register('example.hello', this.sayHello.bind(this))
    
    // 注册菜单项
    context.menus.register({
      id: 'example.menu',
      title: '示例菜单',
      location: 'toolbar',
      onClick: this.sayHello.bind(this)
    })
  }

  // 插件激活时调用
  async onActivate() {
    console.log('插件激活:', this.name)
  }

  // 插件停用时调用
  async onDeactivate() {
    console.log('插件停用:', this.name)
  }

  // 插件卸载时调用
  async onUnload() {
    console.log('插件卸载:', this.name)
    // 清理资源
  }

  // 示例命令
  async sayHello() {
    const { notifications } = this.context
    notifications.show({
      title: 'Hello',
      message: 'Hello from Example Plugin!',
      type: 'info'
    })
  }
}

module.exports = ExamplePlugin
```

## 5. 插件 API 接口

### 5.1 主进程 API

#### 5.1.1 核心服务访问

```javascript
// 只读访问核心服务
context.services = {
  notes: {
    getAll: () => Promise<Note[]>,
    getById: (id) => Promise<Note>,
    search: (query) => Promise<Note[]>
  },
  settings: {
    get: (key) => Promise<any>,
    getAll: () => Promise<object>
  },
  tags: {
    getAll: () => Promise<Tag[]>,
    getPopular: (limit) => Promise<Tag[]>
  }
}
```

#### 5.1.2 IPC 处理器注册

```javascript
// 注册自定义 IPC 处理器
context.ipc.handle('plugin:example:action', async (event, data) => {
  // 处理逻辑
  return result
})
```

#### 5.1.3 数据库 DAO 注册

```javascript
// 注册自定义数据表
context.database.registerDAO('example_table', {
  tableName: 'example_table',
  schema: {
    id: 'INTEGER PRIMARY KEY AUTOINCREMENT',
    name: 'TEXT NOT NULL',
    data: 'TEXT',
    created_at: 'DATETIME DEFAULT CURRENT_TIMESTAMP'
  },
  methods: {
    create: async (data) => { /* 实现 */ },
    findById: async (id) => { /* 实现 */ },
    update: async (id, data) => { /* 实现 */ },
    delete: async (id) => { /* 实现 */ }
  }
})
```

### 5.2 渲染进程 API

#### 5.2.1 UI 组件注册

```javascript
// 注册工具栏按钮
context.ui.toolbar.register({
  id: 'example-button',
  title: '示例按钮',
  icon: 'example-icon',
  position: 'right',
  onClick: () => {
    // 点击处理
  }
})

// 注册侧边栏面板
context.ui.sidebar.register({
  id: 'example-panel',
  title: '示例面板',
  icon: 'example-icon',
  component: ExamplePanelComponent
})

// 注册设置页面
context.ui.settings.register({
  id: 'example-settings',
  title: '示例设置',
  component: ExampleSettingsComponent
})
```

#### 5.2.2 状态管理访问

```javascript
// 只读访问 Zustand Store
const { notes, settings, theme } = context.store.getState()

// 订阅状态变化
context.store.subscribe((state) => {
  // 状态变化处理
})
```

#### 5.2.3 API 调用

```javascript
// 调用主进程 API
const result = await context.api.invoke('plugin:example:action', data)

// 调用系统 API
const notes = await context.api.notes.getAll()
const settings = await context.api.settings.getAll()
```

## 6. 生命周期钩子

### 6.1 插件生命周期

```javascript
class Plugin {
  // 1. 插件加载 - 应用启动时调用
  async onLoad(context) {
    // 初始化插件，注册命令、菜单等
  }

  // 2. 插件激活 - 用户启用插件时调用
  async onActivate() {
    // 启动插件功能
  }

  // 3. 插件停用 - 用户禁用插件时调用
  async onDeactivate() {
    // 停止插件功能，保留数据
  }

  // 4. 插件卸载 - 插件被删除时调用
  async onUnload() {
    // 清理所有资源和数据
  }

  // 5. 应用事件钩子
  async onNoteCreated(note) {
    // 笔记创建时触发
  }

  async onNoteUpdated(note) {
    // 笔记更新时触发
  }

  async onNoteDeleted(noteId) {
    // 笔记删除时触发
  }

  async onSettingChanged(key, value) {
    // 设置变更时触发
  }
}
```

## 7. 权限系统

### 7.1 权限类型

```javascript
const PERMISSIONS = {
  // 笔记权限
  'notes:read': '读取笔记',
  'notes:write': '创建和修改笔记',
  'notes:delete': '删除笔记',
  
  // 设置权限
  'settings:read': '读取设置',
  'settings:write': '修改设置',
  
  // 标签权限
  'tags:read': '读取标签',
  'tags:write': '创建和修改标签',
  
  // 系统权限
  'system:notification': '显示系统通知',
  'system:clipboard': '访问剪贴板',
  'system:filesystem': '访问文件系统',
  
  // 网络权限
  'network:http': '发起 HTTP 请求',
  'network:websocket': '建立 WebSocket 连接'
}
```

### 7.2 权限检查

```javascript
// 在插件代码中检查权限
if (context.permissions.has('notes:write')) {
  // 执行需要写权限的操作
} else {
  throw new Error('缺少 notes:write 权限')
}
```

## 8. 插件管理器

### 8.1 插件发现和加载

```javascript
class PluginManager {
  constructor() {
    this.plugins = new Map()
    this.pluginDir = path.join(__dirname, '../plugins')
  }

  // 扫描插件目录
  async scanPlugins() {
    const pluginDirs = await fs.readdir(this.pluginDir)
    for (const dir of pluginDirs) {
      await this.loadPlugin(dir)
    }
  }

  // 加载单个插件
  async loadPlugin(pluginName) {
    try {
      const pluginPath = path.join(this.pluginDir, pluginName)
      const packageJson = require(path.join(pluginPath, 'package.json'))
      
      // 验证插件兼容性
      if (!this.isCompatible(packageJson)) {
        throw new Error('插件版本不兼容')
      }
      
      // 加载插件类
      const PluginClass = require(path.join(pluginPath, packageJson.main))
      const plugin = new PluginClass()
      
      // 创建插件上下文
      const context = this.createContext(plugin, packageJson)
      
      // 调用插件生命周期
      await plugin.onLoad(context)
      
      this.plugins.set(pluginName, {
        instance: plugin,
        context,
        manifest: packageJson,
        enabled: true
      })
      
      console.log(`插件 ${pluginName} 加载成功`)
    } catch (error) {
      console.error(`插件 ${pluginName} 加载失败:`, error)
    }
  }

  // 创建插件上下文
  createContext(plugin, manifest) {
    return {
      plugin,
      manifest,
      permissions: new PermissionManager(manifest.flashnote?.permissions || []),
      services: this.createServiceProxy(),
      api: this.createAPIProxy(),
      ui: this.createUIProxy(),
      store: this.createStoreProxy(),
      commands: this.createCommandManager(),
      menus: this.createMenuManager(),
      ipc: this.createIPCManager(),
      database: this.createDatabaseManager()
    }
  }
}
```

## 9. 开发指南

### 9.1 创建新插件

1. **初始化插件目录**
   ```bash
   mkdir plugins/my-plugin
   cd plugins/my-plugin
   npm init -y
   ```

2. **编辑 package.json**
   ```json
   {
     "name": "my-plugin",
     "version": "1.0.0",
     "main": "index.js",
     "flashnote": {
       "minVersion": "2.0.0",
       "permissions": ["notes:read"]
     }
   }
   ```

3. **创建插件入口文件**
   ```javascript
   class MyPlugin {
     async onLoad(context) {
       console.log('My Plugin loaded!')
     }
   }
   
   module.exports = MyPlugin
   ```

### 9.2 调试插件

1. **启用开发者模式**
   ```javascript
   // 在设置中启用插件开发者模式
   await context.api.settings.set('plugin.devMode', true)
   ```

2. **查看插件日志**
   ```javascript
   // 插件日志会输出到控制台
   console.log('Plugin debug info:', data)
   ```

3. **热重载插件**
   ```javascript
   // 开发模式下支持插件热重载
   context.api.plugins.reload('my-plugin')
   ```

### 9.3 最佳实践

1. **错误处理**
   ```javascript
   async onLoad(context) {
     try {
       // 插件初始化逻辑
     } catch (error) {
       console.error('插件初始化失败:', error)
       // 优雅降级
     }
   }
   ```

2. **资源清理**
   ```javascript
   async onUnload() {
     // 清理定时器
     if (this.timer) {
       clearInterval(this.timer)
     }
     
     // 移除事件监听器
     this.context.events.removeAllListeners()
     
     // 清理数据库连接
     if (this.db) {
       await this.db.close()
     }
   }
   ```

3. **性能优化**
   ```javascript
   // 使用防抖和节流
   const debounce = require('lodash/debounce')
   
   const debouncedSave = debounce(async (data) => {
     await this.saveData(data)
   }, 1000)
   ```

## 10. 安全考虑

### 10.1 沙箱隔离
- 插件运行在受限的上下文中
- 无法直接访问 Node.js 核心模块
- 通过代理对象访问系统功能

### 10.2 权限控制
- 基于声明式权限系统
- 用户可以查看和管理插件权限
- 运行时权限检查

### 10.3 代码审查
- 插件商店提交需要代码审查
- 自动化安全扫描
- 社区举报机制

## 11. 插件商店

### 11.1 插件发布
1. 准备插件包
2. 编写详细的 README
3. 提交到插件商店
4. 等待审核通过

### 11.2 插件安装
1. 在应用内浏览插件商店
2. 查看插件详情和权限
3. 一键安装和启用
4. 自动更新管理

## 12. 示例插件

### 12.1 Markdown 增强插件
- 提供额外的 Markdown 语法支持
- 自定义渲染器
- 导出功能扩展

### 12.2 云同步插件
- 支持多种云存储服务
- 自动同步笔记数据
- 冲突解决机制

### 12.3 AI 助手插件
- 集成 AI 模型
- 智能摘要生成
- 内容建议和优化

---

通过这个插件系统，开发者可以轻松扩展 FlashNote 的功能，用户可以根据需要安装和管理插件，形成一个活跃的生态系统。